# The Importance of Accounting for Clustered Data {#sec-clustering}


```{r}
#| output: false
#| echo: false

library(lme4) # MLM

library(ggplot2) # beautiful graphs

# library(gganimate) # animated ggplots

# library(plotly) # animated graphs

# library(broom)

library(pander) # nice tables

library(sjPlot) # nice tables for MLM

```


# Grouped and Individual Data

@BlandAltman1994 suggested the following procedure for simulating some data:

> "The data were generated from random numbers, and there is no relation between X and Y at all. Firstly, values of X and Y were generated for each 'subject,' then a further random number was added to make the individual observation." [@BlandAltman1994]

So... we follow their procedure.

```{r}
#| output: false
#| echo: false

set.seed(3846) # random seed

g <- seq(1, 5) # number of groups

x <- rnorm(5, 100, 10) # group x

y <- rnorm(5, 100, 10) # group y

# 5 obs / group

id <- seq(1, 25) 

group_num <- rep(g, 1, each=5)

x_group <- rep(x, each = 5) # x for the group

y_group <- rep(y, each = 5) # y for the group

x_noise <- rnorm(25, 0, 1) # random noise

y_noise <- rnorm(25, 0, 1) # random noise

x_individual <- x_group + x_noise # individual = group + noise

y_individual <- y_group + y_noise # individual = group + noise

mydata <- data.frame(id, 
                     group_num,
                     x_group, 
                     y_group, 
                     x_individual, 
                     y_individual)

```

::: {.callout-note}
## Simulating The Data

The graph below illustrates the process of simulating the data.
:::

```{r}
#| echo: false

ggplot(mydata,
       aes(color = factor(group_num),
           label = group_num)) +
  geom_point(aes(x = x_group, 
                 y = y_group),
             size = 10,
             show.legend = FALSE) + 
  geom_text(aes(x = x_group,
                y = y_group),
            color = "white",
            size = 7,
            show.legend = FALSE) +
  geom_point(aes(x = x_individual, 
                y = y_individual),
             size = 3,
             show.legend = FALSE) + 
  labs(title = "Illustrating the Process of Simulating Clustered Data",
       x = "x",
       y = "y") +
  theme_minimal() +
  scale_color_viridis_d(name = "group")

```

# Analyses

## OLS

An OLS analysis indicates that there is a statistically significant association of $x$ and $y$.

```{r}
#| html-table-processing: none
#| echo: false

myOLS <- lm(y_individual ~ x_individual, data = mydata)

# summary(myOLS)

sjPlot::tab_model(myOLS,
                  dv.labels = c("OLS"),
                  show.se = TRUE,
                  show.ci = FALSE,
                  show.stat = TRUE)

# pander(tidy(myOLS))

```

## MLM

In contrast, an MLM analysis (correctly) finds that there is no statistically significant association of $x$ and $y$.

```{r}
#| echo: false

myMLM <- lmer(y_individual ~ x_individual + (1 | group_num), 
              data = mydata)

# summary(myMLM)

sjPlot::tab_model(myMLM,
                  dv.labels = c("MLM"),
                  show.se = TRUE,
                  show.ci = FALSE,
                  show.stat = TRUE)

# pander(tidy(myMLM))

```

## Compare OLS and MLM

```{r}
#| echo: false

tab_model(myOLS, myMLM,
          dv.labels = c("OLS", "MLM"), 
          show.se = TRUE,
          show.ci = FALSE,
          show.stat = TRUE)

```





